# Infrastructure Setup Guide

## Overview

This project supports two distinct infrastructure environments:

1. **Local Development**: All services running locally via Docker/Supabase CLI
2. **Production**: Cloud services (Supabase Cloud, Qdrant Cloud, Neo4j AuraDB)

## 🏠 Local Development Infrastructure

### Services Used:
- **Supabase**: Local (via `npx supabase start`)
- **PostgreSQL**: Local (via Supabase CLI on localhost:54322)
- **Qdrant**: Local (via Docker on localhost:6333)
- **Neo4j**: Local (via Docker on localhost:7687)

### Setup Commands:
```bash
# 1. Start Supabase locally
npx supabase start

# 2. Start Qdrant and Neo4j via Docker
docker-compose up -d qdrant_db neo4j_unified

# 3. Set environment variables for local development
cp .env.local.example .env.local
```

### Local Environment Variables:
```bash
# ===== LOCAL DEVELOPMENT CONFIGURATION =====

# OpenAI (Required)
OPENAI_API_KEY=your_openai_api_key_here

# Supabase Local (Auto-generated by 'npx supabase start')
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=<auto-generated-anon-key>
SUPABASE_SERVICE_KEY=<auto-generated-service-key>
DATABASE_URL=postgresql://postgres:postgres@localhost:54322/postgres

# Qdrant Local (Docker)
QDRANT_HOST=localhost
QDRANT_PORT=6333
QDRANT_API_KEY=  # Empty for local Docker Qdrant
MAIN_QDRANT_COLLECTION_NAME=openmemory_dev
UNIFIED_QDRANT_COLLECTION_NAME=unified_memory_dev

# Neo4j Local (Docker)
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=fasho93fasho  # Default local password

# Development Settings
ENVIRONMENT=development
USE_UNIFIED_MEMORY=true
DEBUG=true
```

## ☁️ Production Infrastructure

### Services Used:
- **Supabase**: Cloud (your-project.supabase.co)
- **PostgreSQL**: Cloud (via Supabase)
- **Qdrant**: Cloud (Qdrant Cloud)
- **Neo4j**: Cloud (Neo4j AuraDB)

### Production Environment Variables (render.yaml):

#### Backend API Service:
```yaml
envVars:
  # Supabase Cloud
  - key: SUPABASE_URL
    sync: false  # Set to: https://your-project.supabase.co
  - key: SUPABASE_SERVICE_KEY
    sync: false  # Set to: your_supabase_service_key
  - key: SUPABASE_ANON_KEY
    sync: false  # Set to: your_supabase_anon_key
  - key: DATABASE_URL
    sync: false  # Set to: postgresql://postgres:[PASSWORD]@db.[PROJECT].supabase.co:5432/postgres
  
  # Qdrant Cloud
  - key: QDRANT_HOST
    sync: false  # Set to: your-cluster.region.gcp.cloud.qdrant.io
  - key: QDRANT_PORT
    value: "6333"
  - key: QDRANT_API_KEY
    sync: false  # Set to: your_qdrant_cloud_api_key
  - key: MAIN_QDRANT_COLLECTION_NAME
    sync: false  # Set to: your_main_collection
  - key: UNIFIED_QDRANT_COLLECTION_NAME
    value: "unified_memory_prod"
  
  # Neo4j AuraDB (NEW)
  - key: NEO4J_URI
    sync: false  # Set to: neo4j+s://your-instance.databases.neo4j.io
  - key: NEO4J_USER
    sync: false  # Set to: neo4j
  - key: NEO4J_PASSWORD
    sync: false  # Set to: your_neo4j_auradb_password
  
  # OpenAI
  - key: OPENAI_API_KEY
    sync: false  # Set to: your_openai_api_key
  
  # Production Settings
  - key: ENVIRONMENT
    value: "production"
  - key: USE_UNIFIED_MEMORY
    value: "true"
```

#### Frontend UI Service:
```yaml
envVars:
  # API Connection
  - key: NEXT_PUBLIC_API_URL
    value: "https://jean-memory-api-virginia.onrender.com"
  
  # Supabase Cloud (Frontend)
  - key: NEXT_PUBLIC_SUPABASE_URL
    sync: false  # Set to: https://your-project.supabase.co
  - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
    sync: false  # Set to: your_supabase_anon_key
  
  # Neo4j (Optional - for dashboard access)
  - key: NEXT_PUBLIC_NEO4J_URI
    sync: false  # Set to: neo4j+s://your-instance.databases.neo4j.io
  - key: NEXT_PUBLIC_NEO4J_USER
    sync: false  # Set to: neo4j
  # Note: NEO4J_PASSWORD should NOT be exposed to frontend
```

## 🔧 Setting Up Neo4j AuraDB for Production

### 1. Create Neo4j AuraDB Instance:
1. Go to [Neo4j AuraDB](https://neo4j.com/cloud/aura/)
2. Create a new AuraDB Free instance
3. Save the connection details:
   - **URI**: `neo4j+s://your-instance.databases.neo4j.io`
   - **Username**: `neo4j`
   - **Password**: `your-generated-password`

### 2. Configure Production Environment:
In your Render dashboard, set these environment variables:

```bash
NEO4J_URI=neo4j+s://your-instance.databases.neo4j.io
NEO4J_USER=neo4j
NEO4J_PASSWORD=your-generated-password
```

### 3. Test Connection:
```python
from neo4j import GraphDatabase

# Test production Neo4j connection
driver = GraphDatabase.driver(
    "neo4j+s://your-instance.databases.neo4j.io",
    auth=("neo4j", "your-password")
)

with driver.session() as session:
    result = session.run("RETURN 'Hello Neo4j AuraDB!' AS message")
    print(result.single()["message"])

driver.close()
```

## 🚀 Deployment Checklist

### Before Deploying to Production:

- [ ] **Neo4j AuraDB**: Instance created and connection tested
- [ ] **Render Environment Variables**: All Neo4j variables set
- [ ] **Qdrant Cloud**: Collection names updated for production
- [ ] **Supabase**: Production database configured
- [ ] **API Keys**: All required keys added to Render
- [ ] **Testing**: Unified memory system tested locally

### Environment Variable Mapping:

| Service | Local | Production |
|---------|-------|------------|
| **Supabase** | `http://127.0.0.1:54321` | `https://your-project.supabase.co` |
| **PostgreSQL** | `localhost:54322` | Supabase Cloud |
| **Qdrant** | `localhost:6333` | `your-cluster.region.gcp.cloud.qdrant.io` |
| **Neo4j** | `bolt://localhost:7687` | `neo4j+s://your-instance.databases.neo4j.io` |

## 🔍 Verification Commands

### Local Development:
```bash
# Check all local services
docker ps  # Should show qdrant_db and neo4j containers
npx supabase status  # Should show running Supabase services

# Test unified memory system
python quick_user_test.py
```

### Production:
```bash
# Check Render deployment logs
# Verify all environment variables are set
# Test API endpoints via https://jean-memory-api-virginia.onrender.com/docs
```

## 🚨 Security Notes

- **Local Development**: Uses default passwords for convenience
- **Production**: Uses strong, unique passwords for all services
- **Frontend**: Neo4j password should NEVER be exposed to frontend
- **API Keys**: All sensitive keys use `sync: false` in render.yaml

## 📊 Architecture Diagram

```
Local Development:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Supabase CLI  │    │  Docker Qdrant  │    │  Docker Neo4j   │
│  localhost:54321│    │  localhost:6333  │    │  localhost:7687 │
└─────────────────┘    └─────────────────┘    └─────────────────┘

Production:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Supabase Cloud  │    │  Qdrant Cloud   │    │  Neo4j AuraDB   │
│   .supabase.co  │    │ .cloud.qdrant.io│    │.databases.neo4j │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

This setup ensures clean separation between local development and production environments while maintaining the same unified memory system functionality. 