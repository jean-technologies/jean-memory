<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jean Memory - Completing Authentication</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            text-align: center; 
            padding: 50px; 
            background-color: #f8f9fa; 
            color: #343a40; 
        }
        
        .spinner { 
            border: 4px solid #dee2e6; 
            border-top: 4px solid #0d6efd; 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        h1 { font-weight: 300; }
        p { color: #6c757d; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Completing Authentication</h1>
    <div class="spinner"></div>
    <p>Please wait while we securely finalize your connection...</p>

    <script>
        console.log('üîç BRIDGE - OAuth Bridge page loaded');
        console.log('üîç BRIDGE - URL:', window.location.href);
        console.log('üîç BRIDGE - Timestamp:', new Date().toISOString());
        console.log('üîç BRIDGE - User agent:', navigator.userAgent);
        
        // Create visual feedback element
        const debugDiv = document.createElement('div');
        debugDiv.style.cssText = 'position: fixed; top: 100px; left: 10px; background: white; border: 2px solid red; padding: 10px; z-index: 9999; max-width: 80%; font-family: monospace; font-size: 12px;';
        debugDiv.innerHTML = '<h3>üîç BRIDGE DEBUG</h3><div id="debug-content">Loading...</div>';
        document.body.appendChild(debugDiv);
        
        function addDebugLog(message) {
            console.log(message);
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.innerHTML += '<br>' + message;
            }
        }
        
        addDebugLog('üîç BRIDGE - OAuth Bridge page loaded');
        addDebugLog('üîç BRIDGE - URL: ' + window.location.href);

        const getUrlParameter = (name) => {
            // Check both query params and hash fragments
            const queryParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            return queryParams.get(name) || hashParams.get(name);
        };

        // Also store these in sessionStorage so they persist across redirects
        let oauth_session = getUrlParameter('oauth_session') || sessionStorage.getItem('jean_oauth_session');
        let flow = getUrlParameter('flow') || sessionStorage.getItem('jean_flow');
        let api_key = getUrlParameter('api_key') || sessionStorage.getItem('jean_api_key');

        // Store them for persistence
        if (oauth_session) sessionStorage.setItem('jean_oauth_session', oauth_session);
        if (flow) sessionStorage.setItem('jean_flow', flow);
        if (api_key) sessionStorage.setItem('jean_api_key', api_key);

        addDebugLog('üîç BRIDGE - Full URL: ' + window.location.href);
        addDebugLog('üîç BRIDGE - Query params: ' + window.location.search);
        addDebugLog('üîç BRIDGE - Hash params: ' + window.location.hash);
        addDebugLog('üîç BRIDGE - OAuth session found: ' + oauth_session);
        addDebugLog('üîç BRIDGE - Flow type found: ' + flow);
        addDebugLog('üîç BRIDGE - API key found: ' + (api_key ? api_key.substring(0, 12) + '...' : 'none'));
        
        // Check sessionStorage contents
        addDebugLog('üîç BRIDGE - SessionStorage jean_oauth_session: ' + sessionStorage.getItem('jean_oauth_session'));
        addDebugLog('üîç BRIDGE - SessionStorage jean_flow: ' + sessionStorage.getItem('jean_flow'));
        addDebugLog('üîç BRIDGE - SessionStorage jean_api_key: ' + sessionStorage.getItem('jean_api_key'));
        addDebugLog('üîç BRIDGE - SessionStorage jean_final_redirect: ' + sessionStorage.getItem('jean_final_redirect'));

        // Initialize Supabase client
        const supabase = window.supabase.createClient(
            'https://masapxpxcwvsjpuymbmd.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hc2FweHB4Y3d2c2pwdXltYm1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjYxODI3MjYsImV4cCI6MjA0MTc1ODcyNn0.1nSe1h0I9bN_yROdVPJX4L3X0QlqtyFfKMtCJ6XnK9w',
            {
                auth: {
                    detectSessionInUrl: true,
                    flowType: 'pkce'
                }
            }
        );

        // Handle different OAuth flows
        addDebugLog('üîç BRIDGE - Checking flow conditions...');
        addDebugLog('üîç BRIDGE - flow === "mcp_oauth": ' + (flow === 'mcp_oauth'));
        addDebugLog('üîç BRIDGE - oauth_session exists: ' + !!oauth_session);
        addDebugLog('üîç BRIDGE - flow === "sdk_oauth": ' + (flow === 'sdk_oauth'));
        addDebugLog('üîç BRIDGE - api_key exists: ' + !!api_key);
        
        if (flow === 'mcp_oauth' && oauth_session) {
            addDebugLog('üîç BRIDGE - MCP OAuth flow detected, redirecting to API callback.');
            // Existing Claude OAuth flow - redirect to API callback
            const redirectUrl = `https://jean-memory-api-virginia.onrender.com/oauth/callback?oauth_session=${oauth_session}&flow=mcp_oauth`;
            addDebugLog('üéØ BRIDGE - Redirecting to: ' + redirectUrl);
            window.location.href = redirectUrl;
            
        } else if (flow === 'sdk_oauth' && oauth_session && api_key) {
            addDebugLog('üîç BRIDGE - SDK OAuth flow detected, exchanging Supabase session for Jean Memory token.');
            
            // New SDK OAuth flow - exchange Supabase session for Jean Memory token
            (async () => {
                try {
                    addDebugLog('üîç BRIDGE - Starting Supabase session retrieval...');
                    
                    // Get current Supabase session
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    
                    addDebugLog('üîç BRIDGE - Supabase getSession result:');
                    addDebugLog('üîç BRIDGE - Session exists: ' + !!session);
                    addDebugLog('üîç BRIDGE - Session error: ' + (sessionError ? sessionError.message : 'none'));
                    if (session) {
                        addDebugLog('üîç BRIDGE - Session user: ' + (session.user ? session.user.email : 'no user'));
                        addDebugLog('üîç BRIDGE - Session access_token exists: ' + !!session.access_token);
                    }
                    
                    if (sessionError || !session) {
                        addDebugLog('‚ùå BRIDGE - Failed to get Supabase session: ' + (sessionError ? sessionError.message : 'no session'));
                        // Only redirect with error if we were expecting a session (i.e., this is a real OAuth callback)
                        const hasAuthFragment = window.location.hash.includes('access_token') || window.location.search.includes('code=');
                        addDebugLog('üîç BRIDGE - Has auth fragment: ' + hasAuthFragment);
                        if (hasAuthFragment) {
                            addDebugLog('üîç BRIDGE - Redirecting with session error');
                            redirectToApp('Failed to get authentication session');
                        } else {
                            addDebugLog('‚ÑπÔ∏è BRIDGE - No session found, but this might be a direct bridge access - redirecting without error');
                            redirectToApp('No authentication session available');
                        }
                        return;
                    }
                    
                    addDebugLog('‚úÖ BRIDGE - Got Supabase session for user: ' + session.user.email);
                    
                    // Exchange Supabase session for Jean Memory token
                    addDebugLog('üîç BRIDGE - Starting token exchange with API...');
                    const requestBody = {
                        supabase_access_token: session.access_token,
                        api_key: api_key
                    };
                    addDebugLog('üîç BRIDGE - Request body: ' + JSON.stringify(requestBody));
                    
                    const response = await fetch('https://jean-memory-api-virginia.onrender.com/oauth/complete-sdk-auth', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    addDebugLog('üîç BRIDGE - API response status: ' + response.status);
                    addDebugLog('üîç BRIDGE - API response ok: ' + response.ok);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        addDebugLog('‚ùå BRIDGE - Token exchange failed: ' + JSON.stringify(errorData));
                        redirectToApp(`Token exchange failed: ${errorData.error || 'Unknown error'}`);
                        return;
                    }
                    
                    const responseData = await response.json();
                    addDebugLog('üîç BRIDGE - API response data: ' + JSON.stringify(responseData));
                    
                    const { access_token, user } = responseData;
                    addDebugLog('‚úÖ BRIDGE - Successfully exchanged for Jean Memory token for user: ' + user.email);
                    addDebugLog('üîç BRIDGE - Token length: ' + (access_token ? access_token.length : 'no token'));
                    
                    // Redirect back to React app with Jean Memory token
                    addDebugLog('üîç BRIDGE - About to redirect back to app with token...');
                    redirectToApp(null, access_token);
                    
                } catch (error) {
                    addDebugLog('‚ùå BRIDGE - SDK OAuth completion error: ' + error.message);
                    addDebugLog('‚ùå BRIDGE - Error stack: ' + error.stack);
                    redirectToApp(`Authentication failed: ${error.message}`);
                }
            })();
            
        } else {
            addDebugLog('üîç BRIDGE - Unknown or incomplete flow.');
            addDebugLog('üîç BRIDGE - Missing parameters - oauth_session: ' + oauth_session + ', flow: ' + flow + ', api_key: ' + api_key);
            
            // If we have no flow info at all, this might be a direct access - don't redirect with error
            if (!flow && !oauth_session && !api_key) {
                addDebugLog('üîç BRIDGE - Direct bridge access detected, not redirecting.');
                document.body.innerHTML = '<h1>Jean Memory OAuth Bridge</h1><p>This page is used for OAuth authentication. Please use the proper authentication flow.</p><div style="margin-top: 20px; padding: 10px; background: #f0f0f0; font-family: monospace; font-size: 12px;">' + document.getElementById('debug-content').innerHTML + '</div>';
            } else {
                // We have some parameters but not all - this is an error
                addDebugLog('üîç BRIDGE - Redirecting with parameter error');
                redirectToApp('Invalid authentication flow - missing required parameters');
            }
        }

        function redirectToApp(error = null, token = null) {
            addDebugLog('üîç BRIDGE - redirectToApp called with error: ' + error + ', token: ' + (token ? 'YES (' + token.length + ' chars)' : 'NO'));
            
            // Get the original redirect URL from sessionStorage or use default
            const originalUrl = sessionStorage?.getItem('jean_final_redirect') || 'http://localhost:3005';
            addDebugLog('üîç BRIDGE - Original redirect URL: ' + originalUrl);
            
            const redirectUrl = new URL(originalUrl);
            
            if (error) {
                redirectUrl.searchParams.set('auth_success', 'false');
                redirectUrl.searchParams.set('auth_error', error);
                addDebugLog('‚ùå BRIDGE - Redirecting with error: ' + redirectUrl.toString());
            } else if (token) {
                redirectUrl.searchParams.set('auth_success', 'true');
                redirectUrl.searchParams.set('auth_token', token);
                addDebugLog('‚úÖ BRIDGE - Redirecting with success: ' + redirectUrl.toString());
            } else {
                redirectUrl.searchParams.set('auth_success', 'false');
                redirectUrl.searchParams.set('auth_error', 'Unknown error');
                addDebugLog('‚ùå BRIDGE - Redirecting with unknown error: ' + redirectUrl.toString());
            }
            
            addDebugLog('üîç BRIDGE - Final redirect URL: ' + redirectUrl.toString());
            addDebugLog('üîç BRIDGE - About to redirect in 2 seconds...');
            
            // Add a small delay so we can see the debug info
            setTimeout(() => {
                window.location.href = redirectUrl.toString();
            }, 2000);
        }
    </script>
</body>
</html>