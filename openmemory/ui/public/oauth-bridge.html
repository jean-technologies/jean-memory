<!DOCTYPE html>
<html>
<head>
    <title>OAuth Bridge - Jean Memory</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; text-align: center; padding: 50px; background-color: #f8f9fa; color: #343a40; }
        .spinner { border: 4px solid #dee2e6; border-top: 4px solid #0d6efd; 
                   border-radius: 50%; width: 50px; height: 50px; 
                   animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h1 { font-weight: 300; }
        p { color: #6c757d; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Completing Authentication</h1>
    <div class="spinner"></div>
    <p>Please wait while we securely finalize your connection...</p>
    
    <script>
        console.log('üîç BRIDGE - OAuth Bridge page loaded');
        console.log('üîç BRIDGE - URL:', window.location.href);
        
        // This function is robust to handle parameters in either the search string or the hash.
        // Supabase can return parameters in the hash fragment (#) after a redirect.
        const getUrlParameter = (name) => {
            const url = new URL(window.location.href.replace('#', '?')); // Treat hash as search string
            return url.searchParams.get(name);
        };

        const oauth_session = getUrlParameter('oauth_session');
        const flow = getUrlParameter('flow');
        const api_key = getUrlParameter('api_key');
        
        console.log('üîç BRIDGE - OAuth session found:', oauth_session);
        console.log('üîç BRIDGE - Flow type found:', flow);
        console.log('üîç BRIDGE - API key found:', api_key ? api_key.substring(0, 12) + '...' : 'none');

        // Initialize Supabase client for SDK OAuth flows
        const supabase = window.supabase ? window.supabase.createClient(
            'https://masapxpxcwvsjpuymbmd.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hc2FweHB4Y3d2c2pwdXltYm1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjYxODI3MjYsImV4cCI6MjA0MTc1ODcyNn0.1nSe1h0I9bN_yROdVPJX4L3X0QlqtyFfKMtCJ6XnK9w',
            {
                auth: {
                    detectSessionInUrl: true,
                    flowType: 'pkce'
                }
            }
        ) : null;
        
        // Route based on flow type
        if (flow === 'mcp_oauth' && oauth_session) {
            console.log('üîç BRIDGE - MCP OAuth flow detected, redirecting to API callback.');
            
            // Existing Claude OAuth flow - redirect to API callback
            const apiUrl = 'https://jean-memory-api-virginia.onrender.com/oauth/callback';
            const finalUrl = new URL(apiUrl);
            
            // Forward all original URL parameters to the callback
            const originalParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));

            originalParams.forEach((value, key) => finalUrl.searchParams.set(key, value));
            hashParams.forEach((value, key) => finalUrl.searchParams.set(key, value));
            
            console.log('üéØ BRIDGE - Redirecting to:', finalUrl.toString());
            window.location.replace(finalUrl.toString());
            
        } else if (flow === 'sdk_oauth' && oauth_session && api_key && supabase) {
            console.log('üîç BRIDGE - SDK OAuth flow detected, exchanging Supabase session for Jean Memory token.');
            
            // New SDK OAuth flow - exchange Supabase session for Jean Memory token
            (async () => {
                try {
                    // Get current Supabase session
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    
                    if (sessionError || !session) {
                        console.error('‚ùå BRIDGE - Failed to get Supabase session:', sessionError);
                        redirectToApp('Failed to get authentication session');
                        return;
                    }
                    
                    console.log('‚úÖ BRIDGE - Got Supabase session for user:', session.user.email);
                    
                    // Exchange Supabase session for Jean Memory token
                    const response = await fetch('https://jean-memory-api-virginia.onrender.com/oauth/complete-sdk-auth', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            supabase_access_token: session.access_token,
                            api_key: api_key
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('‚ùå BRIDGE - Token exchange failed:', errorData);
                        redirectToApp(`Token exchange failed: ${errorData.error || 'Unknown error'}`);
                        return;
                    }
                    
                    const { access_token, user } = await response.json();
                    console.log('‚úÖ BRIDGE - Successfully exchanged for Jean Memory token for user:', user.email);
                    
                    // Redirect back to React app with Jean Memory token
                    redirectToApp(null, access_token);
                    
                } catch (error) {
                    console.error('‚ùå BRIDGE - SDK OAuth completion error:', error);
                    redirectToApp(`Authentication failed: ${error.message}`);
                }
            })();
            
        } else {
            // If this page is reached without the correct parameters, it's likely a regular
            // app login. Redirecting to the main dashboard is a safe fallback.
            console.log('üîç BRIDGE - Regular app flow or missing parameters, redirecting to dashboard.');
            window.location.replace('/dashboard');
        }

        function redirectToApp(error = null, token = null) {
            // Get the original redirect URL from sessionStorage or use default
            const originalUrl = sessionStorage?.getItem('jean_final_redirect') || 'http://localhost:3005';
            
            const redirectUrl = new URL(originalUrl);
            
            if (error) {
                redirectUrl.searchParams.set('auth_success', 'false');
                redirectUrl.searchParams.set('auth_error', error);
                console.log('‚ùå BRIDGE - Redirecting with error:', redirectUrl.toString());
            } else if (token) {
                redirectUrl.searchParams.set('auth_success', 'true');
                redirectUrl.searchParams.set('auth_token', token);
                console.log('‚úÖ BRIDGE - Redirecting with success:', redirectUrl.toString());
            } else {
                redirectUrl.searchParams.set('auth_success', 'false');
                redirectUrl.searchParams.set('auth_error', 'Unknown error');
                console.log('‚ùå BRIDGE - Redirecting with unknown error:', redirectUrl.toString());
            }
            
            window.location.href = redirectUrl.toString();
        }
    </script>
</body>
</html>