# 🧠 Jean Memory - Local Development Setup Guide

This guide walks you through setting up a complete local development environment that mirrors production functionality using Supabase CLI for authentication.

## 🎯 **Overview**

Your local development setup includes:
- **Supabase CLI** - Local authentication and database (mirrors production Supabase Cloud)
- **Qdrant** - Vector database running in Docker
- **FastAPI** - Backend API server
- **Next.js** - Frontend UI server
- **Automatic Environment Configuration** - Everything configures itself

## 🚀 **One-Command Setup**

```bash
make setup
```

This single command will:
1. ✅ Check all prerequisites (Docker, Node.js, Python)
2. 📦 Install all dependencies (Supabase CLI, Python packages, UI packages)
3. 🗄️ Start local Supabase services
4. 🔍 Start Qdrant vector database
5. 🔧 Auto-configure all environment variables
6. 🔑 Prompt for your API keys (OpenAI required, Gemini optional)
7. 🧪 Verify all services are running

**You only need to provide:**
- OpenAI API Key (required)
- Gemini API Key (optional)

Everything else is automatically configured!

## 📋 **Prerequisites**

- **Docker Desktop** - Must be running
- **Node.js** (18+) - For UI and Supabase CLI
- **Python** (3.8+) - For the API server
- **pnpm** - `brew install pnpm` (on macOS)

## 🗂️ **Environment Files Structure**

The setup creates two environment files:

### `openmemory/.env.local` (UI & Supabase Config)
```bash
# Auto-generated by setup script
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=<auto-generated>
SUPABASE_SERVICE_KEY=<auto-generated>
DATABASE_URL=postgresql://postgres:postgres@localhost:54322/postgres

# User-provided
OPENAI_API_KEY=your_key_here
GEMINI_API_KEY=your_key_here  # optional
```

### `openmemory/api/.env` (API Server Config)
```bash
# Same configuration but uses different variable names
SUPABASE_URL=http://127.0.0.1:54321
SUPABASE_ANON_KEY=<auto-generated>
SUPABASE_SERVICE_KEY=<auto-generated>

# User-provided
OPENAI_API_KEY=your_key_here
GEMINI_API_KEY=your_key_here  # optional
```

## 🔄 **Development Workflow**

### Start Development
```bash
make setup          # One-time setup
cd openmemory
make dev            # Start API + UI servers
```

### Individual Services
```bash
# Start only API server
cd openmemory
make dev-api        # API on http://localhost:8765

# Start only UI server  
cd openmemory
make dev-ui         # UI on http://localhost:3000
```

### Monitoring
```bash
make status         # Check all service status
make logs           # View service logs
make studio         # Open Supabase Studio (database UI)
```

### Restarting
```bash
make restart        # Restart everything
make stop           # Stop all services
```

## 🌐 **Available Services**

Once running, you'll have access to:

| Service | URL | Purpose |
|---------|-----|---------|
| **UI Application** | http://localhost:3000 | Main app interface |
| **API Server** | http://localhost:8765 | Backend API |
| **Supabase Studio** | http://localhost:54323 | Database management UI |
| **Qdrant Dashboard** | http://localhost:6333/dashboard | Vector database UI |

## 🔐 **Authentication Flow**

### Local Development
1. **Real Supabase Auth** - Uses Supabase CLI (same as production)
2. **Multi-user Support** - Create/login multiple test users
3. **JWT Token Validation** - Same security as production
4. **Fallback Developer User** - Auto-created for API testing

### How It Works
```python
# In auth.py - Environment detection
if config.is_local_development:
    # Uses local Supabase CLI at http://127.0.0.1:54321
    # Still validates JWT tokens, creates real users
    local_user = await get_local_dev_user(request, supabase_client, config)
else:
    # Production Supabase Cloud
    user = supabase_client.auth.get_user(token)
```

## 🏗️ **Environment Detection**

The system automatically detects local vs production:

### Local Development Detected When:
- `ENVIRONMENT != "production"` 
- Supabase URL contains `127.0.0.1:54321`

### Production Detected When:
- `ENVIRONMENT=production` (set in Render)
- Supabase URL is cloud-based

### Configuration Priority:
1. `.env.local` (local development - highest priority)
2. `api/.env` (API-specific config)  
3. `.env` (fallback)

## 🚢 **Production Deployment**

### Render Configuration
The `render.yaml` now includes:
```yaml
envVars:
  - key: ENVIRONMENT
    value: "production"  # This triggers production mode
```

### No Local Dev Code in Production
- Production uses `ENVIRONMENT=production`
- Local auth helpers are never called
- Same codebase, different behavior based on environment

### Database Migrations
- **Local**: Uses Supabase CLI migrations
- **Production**: Uses Alembic migrations (as before)

## 🛠️ **Troubleshooting**

### Services Won't Start
```bash
make clean          # Reset everything
make setup          # Start fresh
```

### Supabase Issues
```bash
cd openmemory
npx supabase stop
npx supabase start
make configure-env  # Reconfigure environment
```

### Database Issues
```bash
cd openmemory
make db-reset       # Reset local database
```

### Environment Issues
```bash
make validate-env   # Check configuration
cd openmemory && make configure-env  # Reconfigure
```

## 📁 **Project Structure**

```
your-memory/
├── Makefile                    # Root commands
├── render.yaml                 # Production deployment config
└── openmemory/
    ├── Makefile               # Local dev commands  
    ├── .env.local             # Local environment (auto-generated)
    ├── env.local.example      # Template
    ├── env.example            # API environment template
    ├── supabase/
    │   ├── config.toml        # Supabase CLI config
    │   └── migrations/        # Database migrations
    ├── scripts/
    │   ├── setup-dev-environment.sh  # Main setup script
    │   └── configure-env.sh          # Environment configuration
    ├── api/
    │   ├── .env               # API environment (auto-generated)
    │   └── app/
    │       ├── settings.py    # Environment detection
    │       ├── auth.py        # Authentication
    │       └── local_auth_helper.py
    └── ui/                    # Next.js frontend
```

## 🔧 **Advanced Configuration**

### Adding API Keys Later
```bash
# Edit the files directly
vim openmemory/.env.local
vim openmemory/api/.env

# Or reconfigure everything
cd openmemory && make configure-env
```

### Custom User for Testing
```python
# In your API tests
headers = {"Authorization": "Bearer your-jwt-token"}
response = requests.get("http://localhost:8765/api/v1/memories", headers=headers)
```

### Multiple Environments
You can run multiple projects by changing the Supabase project ID in `supabase/config.toml`.

## ✅ **Verification Checklist**

After setup, verify:
- [ ] UI loads at http://localhost:3000
- [ ] API responds at http://localhost:8765/health
- [ ] Can create user accounts
- [ ] Can login with users
- [ ] Can access dashboard in logged-in state
- [ ] Supabase Studio accessible at http://localhost:54323
- [ ] All services show as running: `make status`

## 🎉 **Success!**

You now have a complete local development environment that:
- ✅ Works identically to production
- ✅ Supports real user authentication
- ✅ Automatically configures itself
- ✅ Doesn't affect production deployments
- ✅ Provides the same user experience as production

Happy coding! 🚀 