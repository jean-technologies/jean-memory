<!DOCTYPE html>
<html>
<head>
    <title>OAuth Bridge - Jean Memory</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="status">Processing OAuth callback...</div>
    
    <script>
        console.log('ðŸŒ‰ OAuth Bridge loaded');
        
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const fragment = new URLSearchParams(window.location.hash.substring(1));
        
        console.log('URL params:', Object.fromEntries(urlParams));
        console.log('Fragment params:', Object.fromEntries(fragment));
        
        // Check if this is an OAuth callback
        const hasOAuthParams = urlParams.has('code') || fragment.has('access_token') || 
                              urlParams.has('oauth_session') || fragment.has('oauth_session');
        
        if (hasOAuthParams) {
            console.log('ðŸ”„ OAuth callback detected, redirecting to API...');
            
            // Extract oauth_session if present
            let oauth_session = urlParams.get('oauth_session') || fragment.get('oauth_session');
            
            // If no oauth_session, try to extract from stored data
            if (!oauth_session) {
                const stored = localStorage.getItem('jean_oauth_session');
                if (stored) {
                    oauth_session = stored;
                    localStorage.removeItem('jean_oauth_session');
                }
            }
            
            // Build redirect URL to API callback
            const apiBase = 'https://jean-memory-api-virginia.onrender.com';
            const callbackUrl = new URL('/oauth/callback', apiBase);
            
            // Preserve all parameters
            urlParams.forEach((value, key) => {
                callbackUrl.searchParams.set(key, value);
            });
            
            fragment.forEach((value, key) => {
                callbackUrl.searchParams.set(key, value);
            });
            
            // Add oauth_session if we have it
            if (oauth_session) {
                callbackUrl.searchParams.set('oauth_session', oauth_session);
            }
            
            console.log('ðŸŽ¯ Redirecting to:', callbackUrl.toString());
            document.getElementById('status').textContent = 'Redirecting to complete authentication...';
            
            // Redirect to API callback
            window.location.href = callbackUrl.toString();
        } else {
            console.log('âŒ No OAuth parameters detected');
            document.getElementById('status').textContent = 'No OAuth callback detected. Redirecting to main app...';
            
            // Redirect to main app after delay
            setTimeout(() => {
                window.location.href = 'https://jeanmemory.com';
            }, 2000);
        }
    </script>
</body>
</html>